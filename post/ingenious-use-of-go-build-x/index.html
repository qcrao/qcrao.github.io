<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Go 命令 『go build -X』 的妙用 | qcrao 的博客</title><meta property="og:title" content="Go 命令 『go build -X』 的妙用 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-03-15T22:08:04+08:00"><meta property="article:modified_time" content="2021-03-15T22:08:04+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="Go 命令 『go build -X』 的妙用"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/ingenious-use-of-go-build-x/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Go 命令 『go build -X』 的妙用</h1></header><date class="post-meta meta-date">2021年3月15日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>不知道大家还记不记得，上次发了一篇关于 panic 检测机器人的<a href=https://mp.weixin.qq.com/s/y9pVNtC6w8Fn0Xqq6EonCw>文章</a>，原理非常简单，简单回顾一下：</p><ol><li>业务服务在 recover 函数里通过 HTTP 请求的方式向机器人上报 panic 栈信息。</li><li>机器人解析出 panic 栈里的代码行号，调用 gitlab 接口拿到该行代码的提交人、提交日期等信息。</li></ol><p>当然，后面我又给机器人增加了一些其他的功能，例如自动拉群，自动提醒相关人修复 panic 代码等……</p><p>上面说的这些其实都很好实现，主要就是和飞书 API 打交道，再加上一些逻辑串连一下流程。目前机器人上报了 1000+ 次 panic，工作状态良好。</p><p>但偶尔还是有一些小问题的存在，例如有人用开发分支（非 master）上到线上测试环境（只读环境）测试一把，这时机器人还是用 master（默认）分支请求 gitlab 接口拿 commit 信息，拿到的信息就有可能不准。</p><p>那有没有什么好的方法能拿到正在运行的进程的代码分支呢？如果能拿到，机器人用代码路径+代码行号+代码分支，就可以从 gitlab 拿到正确的 commit 信息。</p><p>答案是有，通过 <code>go build -X</code> 注入。</p><p>那具体怎么玩的呢，通过一个小例子来说明。</p><p>下面是 <code>build.sh</code> 的代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:teal>COMMIT_ID</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span>git log |head -n 1| awk <span style=color:#d14>&#39;{print $2;}&#39;</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:teal>AUTHOR</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span>git log |head -n 3| grep Author| awk <span style=color:#d14>&#39;{print $2;}&#39;</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:teal>BRANCH_NAME</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>`</span>git branch | awk <span style=color:#d14>&#39;/\*/ { print $2; }&#39;</span><span style=color:#d14>`</span>
</span></span><span style=display:flex><span><span style=color:teal>SERVICE_INFO</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;</span><span style=color:teal>$COMMIT_ID</span><span style=color:#d14>,</span><span style=color:teal>$AUTHOR</span><span style=color:#d14>,</span><span style=color:teal>$BRANCH_NAME</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo</span> <span style=color:teal>$SERVICE_INFO</span>
</span></span><span style=display:flex><span>go build -ldflags <span style=color:#d14>&#34;-X codebase/build-x/compile_info.ServiceInfo=</span><span style=color:teal>$SERVICE_INFO</span><span style=color:#d14>&#34;</span> -o output/bin/build
</span></span></code></pre></div><p>第 3、4、5 行分别用 git 命令拿到本次提交的 commit-id，author，分支名；第 6 行用 “,” 将三者组合成一个字符串；第 8 行用 <code>go build</code> 命令，设置 ldflags，将变量 <code>$SERVICE_INFO</code> 注入到包变量 <code>codebase/build-x/compile_info.ServiceInfo</code>，这样在 Go 代码中就可以直接用了。</p><p>再看看我的 compile_info 包的代码，非常简单，就定义了一个变量：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> compile_info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>var</span> ServiceInfo <span style=color:#458;font-weight:700>string</span>
</span></span></code></pre></div><p>执行完 <code>go build</code> 命令后，compile_info.ServiceInfo 就会被赋上值，在 main 函数里打印一下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;codebase/build-x/compile_info&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>init</span>() {
</span></span><span style=display:flex><span>	fmt.<span style=color:#900;font-weight:700>Println</span>(<span style=color:#d14>&#34;init: &#34;</span>, compile_info.ServiceInfo)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	fmt.<span style=color:#900;font-weight:700>Println</span>(compile_info.ServiceInfo)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>先执行：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sh build.sh
</span></span></code></pre></div><p>再执行：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>~/go/src/codebase/build-x$ ./output/bin/build
</span></span></code></pre></div><p>得到运行结果：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>init:  9699dcaae31e7e5eab55a1d75283a6d7158a64e8,raoquancheng,master
</span></span><span style=display:flex><span>9699dcaae31e7e5eab55a1d75283a6d7158a64e8,raoquancheng,master
</span></span></code></pre></div><p>可知，在 init 函数里我们就可以拿到 compile_info.ServiceInfo 的值了。</p><p>代码文件结构如下：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210313163453.png><img class=mx-auto alt=文件结构 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210313163453.png></a></p><p>原理也没啥可探究的，就是通过 -ldflags 给链接器传参数：</p><blockquote><p>-X definition: 添加形式为 importpath.name=value 的字符串值定义</p></blockquote><p>其他的一些常见的命令用处：</p><blockquote><p><code>-s</code> 的作用是去掉符号信息。 <code>-w</code> 的作用是去掉调试信息。
go build -ldflags &ldquo;-s -w&rdquo; -o xxx</p></blockquote><p>之前看到公司项目里 build 脚本里的一些命令不知道有啥用，真正到了用的时候才惊呼：原来是这样！</p><p>今天的 <code>go build</code> 妙用你学会了吗？也许下次就可以在同事面前装 B 了，当然如果碰到了老司机，也可能会被打脸。</p><h1 id=参考资料>参考资料</h1><p>【ldflags go version】 <a href=https://ms2008.github.io/2018/10/08/golang-build-version/>https://ms2008.github.io/2018/10/08/golang-build-version/</a></p><p>【go build 命令】 <a href=https://github.com/hyper0x/go_command_tutorial/blob/master/0.1.md>https://github.com/hyper0x/go_command_tutorial/blob/master/0.1.md</a></p><p>【Go 编译命令】 <a href=https://chenwenke.cn/blog/2019/11/05/2019-11-05-go-build/>https://chenwenke.cn/blog/2019/11/05/2019-11-05-go-build/</a></p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/ingenious-use-of-go-build-x/>https://qcrao.com/post/ingenious-use-of-go-build-x/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2022 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li><li><a href=https://qcrao.com/post/go-tls-pr-by-xargin/ title="曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr">曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr</a></li><li><a href=https://qcrao.com/post/start-to-build-up-personal-tools/ title="曹大带我学 Go（9）—— 开始积累自己的工具库">曹大带我学 Go（9）—— 开始积累自己的工具库</a></li><li><a href=https://qcrao.com/post/accident-by-a-metric/ title="曹大带我学 Go（8）—— 一个 metrics 打点引发的事故">曹大带我学 Go（8）—— 一个 metrics 打点引发的事故</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>