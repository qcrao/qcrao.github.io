<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>曹大带我学 Go（8）—— 一个 metrics 打点引发的事故 | qcrao 的博客</title><meta property="og:title" content="曹大带我学 Go（8）—— 一个 metrics 打点引发的事故 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-07-19T23:28:24+08:00"><meta property="article:modified_time" content="2021-07-19T23:28:24+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="曹大带我学 Go（8）—— 一个 metrics 打点引发的事故"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/accident-by-a-metric/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>曹大带我学 Go（8）—— 一个 metrics 打点引发的事故</h1></header><date class="post-meta meta-date">2021年7月19日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>最近线上事故频发，搞得焦头烂额，但是能用上跟曹大学的知识并定位出了问题，还是值得高兴一把的。毕竟“打破砂锅问到底”，“定位出根因”一直是技术人的优良品质。</p><p>虽然我们总是逃不过事故驱动开发的魔咒，但吃一堑长一智，看别人的事故，学到的是自己的能力。</p><h1 id=现象>现象</h1><p>一个平凡的午高峰，服务在全量上线的过程中，碰到一个非常重要的下游接口超时（后来发现该下游也在上线，可用实例数变少，正常实例负载变高，超时了一丢丢），拿不到该拿的数据，阻塞了启动。这样，打到线上正常实例上的流量就增加了。</p><p>不大会儿，线上大量实例 OOM，报警满天飞。不得已，回滚（遇到事故，第一件事就是回滚）。没想到，回滚无效，OOM 的实例数还是一直在增加，给跪了。</p><p>中间查到服务在启动过程中，一直在尝试调那个超时的下游，就临时把超时时间加大，并取消回滚，紧急上线了一把。</p><p>之后，正常启动的实例越来越多，服务逐渐恢复。</p><h1 id=第一天排查>第一天排查</h1><p>发生事故之后就是排查过程了。</p><p>第一天，只查到了 OOM 的实例 goroutine 数暴涨，接口 QPS 有尖峰，比正常翻了几倍。所以，得到的结论就是接口流量太多，超过服务极限，导致 OOM。</p><p>接着尝试在预览环境压测，没有复现 OOM，gg。</p><p>结论有问题！</p><h1 id=第二天排查>第二天排查</h1><p>第二天运气比较好，发现了线上有一个实例在不断地重启，一看监控，发现正常启动后，5 分钟左右就 OOM 了。</p><p>有现场就不慌。</p><p>正好跟着曹大学会了如何用 pprof 查问题，马上就安排，三下五除二就搞定了。</p><p>先看 inuse_space：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233301.png><img class=mx-auto alt=inuse_space src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233301.png></a></p><p>虽然，这个 model 占用的内存比较高，但这是正常的业务逻辑，看了看相关的代码最近也没有改动。</p><p><strong>所以，这个只能是果，不是因。</strong></p><p>再看 CPU：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233443.png><img class=mx-auto alt=CPU src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233443.png></a></p><p>中间加粗的红色线条和方框就差要告诉我有问题的代码在哪一行了！图上方有调 metrics 的函数名（这里没展示出来），一搜就搜出来了。</p><p>再看了下 goroutine：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233653.png><img class=mx-auto alt=goroutine src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210718233653.png></a></p><p>结论还是一样的。</p><p>顺着图上的函数名，马上就在一个多重嵌套循环里找到了一处不那么显眼的打点。</p><p><code>metrics</code> 打点的剧本我熟，之前看了曹大的“几个 Go 系统可能遇到的锁问题”的文章（点击阅读原文可读），逻辑大概是这样的：</p><blockquote><p>由于 <code>metrics</code> 底层是用 udp 发送的，有文件锁，大量打点的情况下，会引起激烈的锁冲突，造成 goroutine 堆积、请求堆积，和请求关联的 model 无法释放，于是就 OOM 了。</p></blockquote><p>然后我们替换 bin 上到这台 OOM 的机器，果然恢复正常了，收工！</p><p>最后看了下 metrics 的代码，其实还不是文件锁的原因。不过也差不多了，也是一把大锁，所有 goroutine 的打点都会先 append 到一个 slice 里，append 前要先加锁。</p><p>由于这个地方的打点非常多，几十万 QPS，一冲突，goroutine 都 gopark 去等锁了，持有的内存无法释放，服务一会儿就 gg 了。</p><h1 id=总结>总结</h1><p>引发这次事故的代码其实是一年多前写的，跑了一年都没出事，这次就遇到了，你说可气不？</p><p>幸亏不是自己写的，但也要敲个警钟：我写的每一行代码，将来都可能会引发事故，一定要认真对待。</p><p>遇到 OOM 不可怕，有现场就行。拿不到现场，我也没啥好办法。实在不行，用曹大的 holmes 试试，这个工具还是很厉害的，还帮曹大贡献了个 golang 的 mr。</p><p>平时要多看相关的事故排查文章，必要的时候练习一下 pprof 工具的使用，关键的时候还是能顶用的。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/accident-by-a-metric/>https://qcrao.com/post/accident-by-a-metric/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2022 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/100-go-mistakes-reading-notes/ title="深度阅读之《100 Go Mistakes and How to Avoid Them》">深度阅读之《100 Go Mistakes and How to Avoid Them》</a></li><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li><li><a href=https://qcrao.com/post/go-tls-pr-by-xargin/ title="曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr">曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr</a></li><li><a href=https://qcrao.com/post/start-to-build-up-personal-tools/ title="曹大带我学 Go（9）—— 开始积累自己的工具库">曹大带我学 Go（9）—— 开始积累自己的工具库</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>