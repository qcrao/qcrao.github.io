<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>曹大带我学 Go（3）—— 如何用汇编打同事的脸 | qcrao 的博客</title><meta property="og:title" content="曹大带我学 Go（3）—— 如何用汇编打同事的脸 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-05-27T23:21:54+08:00"><meta property="article:modified_time" content="2021-05-27T23:21:54+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="曹大带我学 Go（3）—— 如何用汇编打同事的脸"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/how-to-get-asm-code-of-go/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>曹大带我学 Go（3）—— 如何用汇编打同事的脸</h1></header><date class="post-meta meta-date">2021年5月27日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>今天介绍几个常用的查看 Go 汇编代码、调试 Go 程序的命令和工具，既可以在平时和同事、网友抬杠时使用，还能在关键时刻打他们的脸。</p><p>比如，有同事说这段代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> Student <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>	Class <span style=color:#458;font-weight:700>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> a = <span style=color:#000;font-weight:700>&amp;</span>Student{<span style=color:#099>1</span>}
</span></span><span style=display:flex><span>	<span style=color:#0086b3>println</span>(a)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>的执行效率要高于下面这段代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> Student <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>	Class <span style=color:#458;font-weight:700>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> a = Student{<span style=color:#099>1</span>}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> b = <span style=color:#000;font-weight:700>&amp;</span>a
</span></span><span style=display:flex><span>	<span style=color:#0086b3>println</span>(b)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>并且给你讲了一通道理，你好像没法辩赢他。怎么办？</p><p>直接用一行命令生成汇编代码，马上可以戳穿他，打他的脸。</p><h1 id=go-tool-生成汇编>go tool 生成汇编</h1><p>其实很简单，有两个命令可以做到：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go tool compile -S main.go
</span></span></code></pre></div><p>和：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go build main.go <span style=color:#000;font-weight:700>&amp;&amp;</span> go tool objdump ./main
</span></span></code></pre></div><p>前者是编译，即将源代码编译成 <code>.o</code> 目标文件，并输出汇编代码。</p><p>后者是反汇编，即从可执行文件反编译成汇编，所以要先用 <code>go build</code> 命令编译出可执行文件。</p><p>二者不尽相同，但都能看到前面两个示例代码对应的汇编代码是一致的。同事的“谣言”不攻自破，脸都被你打疼了。</p><h1 id=找到-runtime-源码>找到 runtime 源码</h1><p>Go 是一门有 runtime 的语言，什么是 runtime？其实就是一段辅助程序，用户没有写的代码，runtime 替我们写了，比如 Go 调度器的代码。</p><p>我们只需要知道用 go 关键字创建 goroutine，就可以疯狂堆业务了。至于 goroutine 是怎么被调度的，根本不需要关心，这些是 runtime 调度器的工作。</p><p>那我们自己写的代码如何和 runtime 里的代码对应起来呢？</p><p>前面介绍的方法就可以做到，只需要加一个 <code>grep</code> 就可以。</p><p>例如，我想知道 go 关键字对应 runtime 里的哪个函数，于是写了一段测试代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>go</span> <span style=color:#000;font-weight:700>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#0086b3>println</span>(<span style=color:#099>1</span><span style=color:#000;font-weight:700>+</span><span style=color:#099>2</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>因为 <code>go func(){}()</code> 那一行代码在第 4 行，所以，grep 的时候加一个条件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go tool compile -S main.go | grep <span style=color:#d14>&#34;main.go:4&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// 或
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go build main.go <span style=color:#000;font-weight:700>&amp;&amp;</span> go tool objdump ./main | grep <span style=color:#d14>&#34;main.go:4&#34;</span>
</span></span></code></pre></div><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525232528.png><img class=mx-auto alt="go func" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525232528.png></a></p><p>马上就能看到 <code>go func(){}()</code> 对应 <code>newproc()</code> 函数，这时再深入研究下 <code>newproc()</code> 函数就大概知道 goroutine 是如何被创建的。</p><h1 id=用-dlv-调试>用 dlv 调试</h1><p>那有同学问了，有没有其他可以调试 Go、以及和 Go 程序互动的方法呢？其实是有的！这就是我们要介绍的 dlv 调试工具，目前它对调试 Go 的程序支持是最好的。</p><p>之前没我怎么研究它，只会一些非常简单的命令，这次学会了几个进阶的指令，威力挺大，也进一步加深了对 Go 的理解。</p><p>下面我们带着一个任务来讲解 dlv 如何使用。</p><p>我们知道，向一个 nil 的 slice append 元素，不会有任何问题。但是向一个 nil 的 map 插入新元素，马上就会报 panic。这是为什么呢？又是在哪 panic 呢？</p><p>首先写出让 map 产生 panic 的示例程序：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> m <span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>int</span>]<span style=color:#458;font-weight:700>int</span>
</span></span><span style=display:flex><span>	m[<span style=color:#099>1</span>] = <span style=color:#099>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接着用 <code>go build</code> 命令编译生成可执行文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go build a.go
</span></span></code></pre></div><p>然后，使用 dlv 进入调试状态：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dlv <span style=color:#0086b3>exec</span> ./a
</span></span></code></pre></div><p>使用 <code>b</code> 这个命令打断点，有三种方法：</p><ol><li>b + 地址</li><li>b + 代码行数</li><li>b + 函数名</li></ol><p>我们要在对 map 赋值的地方加个断点。先找到代码位置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat -n a.go
</span></span></code></pre></div><p>看到：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234605.png><img class=mx-auto alt=hello.go src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234605.png></a></p><p>赋值的地方在第 5 行，加断点：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#000;font-weight:700>(</span>dlv<span style=color:#000;font-weight:700>)</span> b a.go:5
</span></span><span style=display:flex><span>Breakpoint <span style=color:#099>1</span> <span style=color:#0086b3>set</span> at 0x45e55d <span style=color:#000;font-weight:700>for</span> main.main<span style=color:#000;font-weight:700>()</span> ./a.go:5
</span></span></code></pre></div><p>执行 <code>c</code> 命令，直接运行到断点处：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233423.png><img class=mx-auto alt=运行到断点处 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233423.png></a></p><p>执行 <code>disass</code> 命令，可以看到汇编指令：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233635.png><img class=mx-auto alt=disass src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233635.png></a></p><p>这时使用 <code>si</code> 命令，执行单条指令，多次执行 <code>si</code>，就会执行到 map 赋值函数 <code>mapassign_fast64</code>：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233856.png><img class=mx-auto alt=mapassign_fast64 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525233856.png></a></p><p>这时再用单步命令 <code>s</code>，就会进入判断 h 的值为 nil 的分支，然后执行 <code>panic</code> 函数：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234044.png><img class=mx-auto alt=panic src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234044.png></a></p><p>至此，向 nil 的 map 赋值时，产生 panic 的代码就被我们找到了。接着，按图索骥找到对应 runtime 源码的位置，就可以进一步探索了。</p><p>除此之外，我们还可以使用 <code>bt</code> 命令看到调用栈：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234258.png><img class=mx-auto alt=调用栈 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20210525234258.png></a></p><p>使用 <code>frame 1</code> 命令可以跳转到相应位置。这里 <code>1</code> 对应图中的 <code>a.go:5</code>，也就是我们前面打断点的地方，是不是非常酷炫。</p><p>上面这张图里我们也能清楚地看到，用户 goroutine 其实是被 goexit 函数一路调用过来的。当用户 goroutine 执行完毕后，就会回到 goexit 函数做一些收尾工作。当然，这是题外话了。</p><p>另外，用 dlv 也能干第二部分“找到 runtime 源码”的活。</p><h1 id=总结>总结</h1><p>今天系统地讲了几招通过命令和工具查看用户代码对应的 runtime 源码或者汇编代码的方法，非常实用。最后再汇总一下：</p><ol><li>go tool compile</li><li>go tool objdump</li><li>dlv</li></ol><p>使用这些命令和工具，可以让你在看 Go 源码的过程中事半功倍。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/how-to-get-asm-code-of-go/>https://qcrao.com/post/how-to-get-asm-code-of-go/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/how-to-be-a-TO/ title="项目 TO 的自我修养">项目 TO 的自我修养</a></li><li><a href=https://qcrao.com/post/how-to-write-a-things3-client/ title="如何写一个 things3 client">如何写一个 things3 client</a></li><li><a href=https://qcrao.com/post/some-convenient-settings-of-mac/ title="几个小设置让 mac 更好用">几个小设置让 mac 更好用</a></li><li><a href=https://qcrao.com/post/100-go-mistakes-reading-notes/ title="深度阅读之《100 Go Mistakes and How to Avoid Them》">深度阅读之《100 Go Mistakes and How to Avoid Them》</a></li><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>