<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>聊聊 g0 | qcrao 的博客</title><meta property="og:title" content="聊聊 g0 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-04-03T15:27:15+08:00"><meta property="article:modified_time" content="2020-04-03T15:27:15+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="聊聊 g0"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/talk-about-g0/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>聊聊 g0</h1></header><date class="post-meta meta-date">2020年4月3日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>很多时候，当我们跟着源码去理解某种事物时，基本上可以认为是以时间顺序展开，这是编年体的逻辑。还有另一种逻辑，纪传体，它以人物为中心编排史事，使得读者更聚焦于某个人物。以一种新的视角，把所有的事情串连起来，令人大呼过瘾。今天我们试着以这样一种逻辑再看 g0。</p><p>回顾一下 Go 夜读<a href=https://mp.weixin.qq.com/s/Yr4L2pt-__CK7Q7JVz_guw>第 78 期</a>，关于调度器源码分析的内容。我们讲过，与主线程绑定的 M 对应的 g0 的主要作用是提供一个比一般 goroutine 要大的多栈（64K）供 runtime 代码执行。</p><p>初始化的过程中，在函数 <code>runtime·rt0_go</code> 里会给主线程的 g0 分配栈空间：</p><p><a data-fancybox=gallery href=https://user-images.githubusercontent.com/7698088/64071133-d400c080-cca5-11e9-8563-d5f882e34e0a.png><img class=mx-auto alt="g0 栈空间" src=https://user-images.githubusercontent.com/7698088/64071133-d400c080-cca5-11e9-8563-d5f882e34e0a.png></a></p><p>之后，主线程会与 m0 绑定，m0 又与 g0 绑定：</p><p><a data-fancybox=gallery href=https://user-images.githubusercontent.com/7698088/75735730-54c47600-5d36-11ea-912a-7ab8dcbda1dc.png><img class=mx-auto alt="主线程绑定 m0，g0" src=https://user-images.githubusercontent.com/7698088/75735730-54c47600-5d36-11ea-912a-7ab8dcbda1dc.png></a></p><p>之后，又与 p0 绑定：</p><p><a data-fancybox=gallery href=https://user-images.githubusercontent.com/7698088/64071128-97cd6000-cca5-11e9-95a9-344f2a0a6474.png><img class=mx-auto alt=g0-p0-m0 src=https://user-images.githubusercontent.com/7698088/64071128-97cd6000-cca5-11e9-95a9-344f2a0a6474.png></a></p><p>这样，主线程的这一套 GPM 就可以转起来了。接着，就创建了 main goroutine，放入 p0 的本地待运行队列。最后，通过 <code>schedule()</code> 函数进入调度循环。</p><p>前面说的是程序初始化的过程中，g0 是如何诞生的。当执行到 <code>main.main()</code> 函数，也说是用户在 main 包下写的 main 函数里，我们随手一句：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#75715e>// 要做的事
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#75715e></span><span style=color:#111>}()</span>
</span></span></code></pre></div><p>就启动了一个 goroutine 时，在 Go 编译器的作用下，最终会转化成 newproc 函数。在 newproc 函数的内部，会在 g0 栈上调用 <code>newproc1</code> 函数，完成后续的工作。创建完成后，会将新创建的 goroutine 放入 <code>_p_</code> 的本地待运行队列。</p><p>因为新增加了一个 g，这时会尝试去唤醒一个 P 来一起执行任务。判断条件是：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>npidle</span><span style=color:#111>)</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>nmspinning</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>mainStarted</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#75af00>wakep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>即在有空闲 P 以及没有正在“找工作的 M”的情况下，才会尝试去唤醒一个 P。我们又知道，其实 P 的数量在程序运行过程中一般不会变化，所以这里所谓的唤醒其实就是把空闲的 P 利用起来。</p><p>通过 <code>wakep() -> startm() -> newm() -> allocm() -> malg()</code> 这条链路创建 g0，这里 g0 的栈大小实际上为 <code>8KB</code>。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>g0</span> <span style=color:#111>=</span> <span style=color:#75af00>malg</span><span style=color:#111>(</span><span style=color:#ae81ff>8192</span> <span style=color:#f92672>*</span> <span style=color:#75af00>sys</span><span style=color:#111>.</span><span style=color:#75af00>StackGuardMultiplier</span><span style=color:#111>)</span> <span style=color:#75715e>// sys.StackGuardMultiplier 在 linux 里为 1
</span></span></span></code></pre></div><p><code>g0</code> 作为一个特殊的 goroutine，为 scheduler 执行调度循环提供了场地（栈）。对于一个线程来说，g0 总是它第一个创建的 goroutine。之后，它会不断地寻找其他普通的 goroutine 来执行，直到进程退出。</p><p>当需要执行一些任务，且不想扩栈时，就可以用到 g0 了，因为 g0 的栈比较大。g0 其他的一些“职责”有：创建 goroutine、deferproc 函数里新建 _defer、垃圾回收相关的工作（例如 stw、扫描 goroutine 的执行栈、一些标识清扫的工作、栈增长）等等。</p><p>因为 g0 这样一个特殊的 goroutine 所做的工作，使得 Go 程序运行地更快。</p><p>注：最近在 medium 上看到了一个非常赞的关于 Go 的<a href=https://medium.com/a-journey-with-go>博客</a>，题图画得很有阅读的欲望。这篇文章也是参考于<a href=https://medium.com/a-journey-with-go/go-g0-special-goroutine-8c778c6704d8>其中的一篇</a>。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/talk-about-g0/>https://qcrao.com/post/talk-about-g0/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2022 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li><li><a href=https://qcrao.com/post/go-tls-pr-by-xargin/ title="曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr">曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr</a></li><li><a href=https://qcrao.com/post/start-to-build-up-personal-tools/ title="曹大带我学 Go（9）—— 开始积累自己的工具库">曹大带我学 Go（9）—— 开始积累自己的工具库</a></li><li><a href=https://qcrao.com/post/accident-by-a-metric/ title="曹大带我学 Go（8）—— 一个 metrics 打点引发的事故">曹大带我学 Go（8）—— 一个 metrics 打点引发的事故</a></li><li><a href=https://qcrao.com/post/how-to-use-functional-options-pattern/ title="曹大带我学 Go（7）—— 如何优雅地指定配置项">曹大带我学 Go（7）—— 如何优雅地指定配置项</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>