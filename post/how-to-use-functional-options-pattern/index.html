<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>曹大带我学 Go（7）—— 如何优雅地指定配置项 | qcrao 的博客</title><meta property="og:title" content="曹大带我学 Go（7）—— 如何优雅地指定配置项 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-07-15T23:28:02+08:00"><meta property="article:modified_time" content="2021-07-15T23:28:02+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="曹大带我学 Go（7）—— 如何优雅地指定配置项"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/how-to-use-functional-options-pattern/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>曹大带我学 Go（7）—— 如何优雅地指定配置项</h1></header><date class="post-meta meta-date">2021年7月15日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>最近一个年久失修的库导致了线上事故，不得不去做一些改进。</p><p>这个陈年库的作用是调用第三方的 RPC 拿一些比较重要的配置，业务代码中有段逻辑会根据读到的配置调用不同端的下游。如果没拿到配置，就会默认地调一个兜底下游。恰好这个兜底下游最近新上了一些逻辑，不兼容这种跨端调用，直接把它打挂了。</p><p>先抛开这个下游不健壮不谈，假设它是健壮的。</p><p>陈年库的问题在于：进程启动时它会去调一个下游拿数据，之后会定时更新。但如果启动时调用失败就直接 panic 了，所以之后也不会定时更新。理论上这个也没什么问题，服务在初始化时如果检测到了库的 panic，进程退出，重启就好了。</p><p>但是阻塞启动是比较危险的，所以有些服务就会吞掉 panic。于是，整个进程生命周期内这个配置就一直是缺失的状态。</p><p>因为阻塞服务的启动风险太高，所以当前的状态是把 panic recover 住了，但是之后这个配置也就一直没有更新的机会了。而陈年库其实是可以在后台静默更新数据的。</p><p>因此我要对陈年库要做一点改进：如果初始化时拉取配置失败，不 panic，后台静默修复。这个设置要在调用 Init 函数时设置，因为库就暴露了 Init 和 Get 函数。</p><p>但因为这个库有很多使用方，所以不可能更改函数签名和现在的行为，否则影响其他人使用。万一有业务都对这个是强依赖，就是要感知 panic，初始化失败就进程退出，你改了不就 gg 了。</p><p>我们知道，Go 语言里面有可变参数，调用它的时候可以不传实参，或者传多个实参。向陈年库函数的 Init 函数签名后加一个可变参数：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>Init</span>(a <span style=color:#458;font-weight:700>int</span>)
</span></span></code></pre></div><p>变成：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>Init</span>(a <span style=color:#458;font-weight:700>int</span>, opts <span style=color:#000;font-weight:700>...</span>optionFunc)
</span></span></code></pre></div><p>这样就不影响已有的用户了，并且我可以增加更多的设置项。这里的关键是 <code>optionFunc</code> 的实现原理是什么？</p><p>它其实是一个函数类型，它接受 <code>options</code> 结构体指针：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> optionFunc <span style=color:#000;font-weight:700>func</span>(<span style=color:#000;font-weight:700>*</span>options)
</span></span></code></pre></div><p>再定义一个 options 结构体用于放 bool 型变量 <code>PanicWhenInitFail</code>，表示 Init 失败后是否 panic：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> options <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>	PanicWhenInitFail <span style=color:#458;font-weight:700>bool</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再来定义一个导出的函数，用户传入 bool 型变量就可以设置 options，而不用定义 options 对象。这种方法美妙的地方就在这里，要多次回味才能感受到：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>WithPanicWhenInitFail</span>() optionFunc {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>func</span>(o <span style=color:#000;font-weight:700>*</span>options) {
</span></span><span style=display:flex><span>		o.PanicWhenInitFail = <span style=color:#000;font-weight:700>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>初始时，Init 函数的实现如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>Init</span>(a <span style=color:#458;font-weight:700>int</span>) {
</span></span><span style=display:flex><span>	fmt.<span style=color:#900;font-weight:700>Println</span>(a)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>修改后：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>Init</span>(a <span style=color:#458;font-weight:700>int</span>, opts <span style=color:#000;font-weight:700>...</span>optionFunc) {
</span></span><span style=display:flex><span>	fmt.<span style=color:#900;font-weight:700>Println</span>(a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>var</span> gOpt = <span style=color:#000;font-weight:700>&amp;</span>options{PanicWhenInitFail: <span style=color:#000;font-weight:700>false</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>for</span> _, opt <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> opts {
</span></span><span style=display:flex><span>		<span style=color:#900;font-weight:700>opt</span>(gOpt)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#900;font-weight:700>Println</span>(gOpt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样，main 函数就可以非常优雅地设置 <code>PanicWhenInitFail</code> 了：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Init</span>(<span style=color:#099>8</span>)
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Init</span>(<span style=color:#099>8</span>, <span style=color:#900;font-weight:700>WithPanicWhenInitFail</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>不管加不加后面的配置，两种调用方式都可以编译成功，不会影响现有的用户，完美。</p><p>为什么这篇文章和曹大扯上关系，因为在曹大写的 <a href=https://github.com/mosn/holmes>mosn/homels</a> 这个库里也有类似的代码。当然，本文这种形式很常见，可以算作标配了。不过，有一点点不同之处，曹大定义了一个 interface，不过看起来感觉有点更难懂了。😇</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// Option holmes option type.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>type</span> Option <span style=color:#000;font-weight:700>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>apply</span>(<span style=color:#000;font-weight:700>*</span>options) <span style=color:#458;font-weight:700>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> optionFunc <span style=color:#000;font-weight:700>func</span>(<span style=color:#000;font-weight:700>*</span>options) <span style=color:#458;font-weight:700>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (f optionFunc) <span style=color:#900;font-weight:700>apply</span>(opts <span style=color:#000;font-weight:700>*</span>options) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>f</span>(opts)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>去 Google 上一查，其实这种形式，叫 <code>Functional Options Pattern</code>，早在 2014 年 Rob Pike 就写过一篇<a href=https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html>博文</a>来说这个事，没几行代码，但是真的很优雅。</p><p>总结一下，当我们要修改已有的函数时，为了不破坏原有的签名和行为，可以使用 <code>Functional Options Pattern</code> 的形式增加可变参数，即可以增加设置项，又能兼容已有的代码。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/how-to-use-functional-options-pattern/>https://qcrao.com/post/how-to-use-functional-options-pattern/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/how-to-write-a-things3-client/ title="如何写一个 things3 client">如何写一个 things3 client</a></li><li><a href=https://qcrao.com/post/some-convenient-settings-of-mac/ title="几个小设置让 mac 更好用">几个小设置让 mac 更好用</a></li><li><a href=https://qcrao.com/post/100-go-mistakes-reading-notes/ title="深度阅读之《100 Go Mistakes and How to Avoid Them》">深度阅读之《100 Go Mistakes and How to Avoid Them》</a></li><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>