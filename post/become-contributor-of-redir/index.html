<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>喜提 redir contributor | qcrao 的博客</title><meta property="og:title" content="喜提 redir contributor - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-11-16T09:30:00+08:00"><meta property="article:modified_time" content="2020-11-16T09:30:00+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="喜提 redir contributor"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/become-contributor-of-redir/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>喜提 redir contributor</h1></header><date class="post-meta meta-date">2020年11月16日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>看多了 Go 源代码，看一看应用，尤其是比较短小且有趣的应用代码，感觉很有意思，而且举重若轻。</p><p>如果顺带修一下小的<a href=https://github.com/golang-design/redir/pull/3>错误</a>，成为 Contributor，那就更多了一种成就感。就像杨文前几天成为 Go Contributor <a href=https://go-review.googlesource.com/c/tools/+/269397>那样</a>，从小处开始，慢慢提升技术含量，总有一天，慢慢成为真正的 Contributor，像曹大<a href=https://go-review.googlesource.com/c/go/+/263277>那样</a>。</p><p>某天欧神和杨文不知道怎么鼓捣出了一个 <a href=https://golang.design/>golang.design</a> 网站，前一阵子欧神又发布了一个 <a href=https://github.com/golang-design/redir>redir</a> 项目。它其实是一个跳转，比如，欧神分享的 Gophercon 2020 的 PPT 链接：https://golang.design/s/gophercon2020，其实最后会跳转到一个 dropbox 的一个文件分享页面。但是用 “/s/gophercon2020” 就会显得非常的优雅和高级。类似的，还有一些欧神做的分享，如 <a href=https://golang.design/s/go2generics>https://golang.design/s/go2generics</a> 等，都会通过 <code>/s/</code> 跳转到实际的地址去。至于为什么是 <code>/s/</code> 路径，其实这个项目最初的名字是 short，也就是短网址的意思。</p><p>所以，我今天要介绍的就是 redir 的实现原理以及部署。</p><p>首先来看一下 redir 的两个核心功能：短网址跳转（/s）；处理 <code>go get</code> 请求（/x）。前者很好理解，我访问短网址 <a href=https://golang.design/s/go2generics>https://golang.design/s/go2generics</a>，redir 给我重定向到真实的 google slice 的地址；后者则不那么好理解，它处理的是我们在项目中 import 了一个 golang.design 下面的某个包，例如：<code>import "golang.design/x/verbose"</code>
，那么 <code>go get</code> 来获取这个包的时候会去 github 上 golang.design 相应目录下找，但这一切并不是自然发生的，需要通过返回的 <code>header</code> 告知 <code>go get</code> 一些信息。</p><p>对于比较知名的，如 github，我这样写：<code>import github.com/go-redis/redis/v8</code>，<code>go get</code> 就知道去 github 官网去找，但是对于 golang.design 的库那就不知道怎么找了，所以它会尝试访问 <code>https://golang.design/x/pkg/foo?go-get=1</code> 来获取相关信息，于是 <code>/x</code> handler 就在 header 里返回 meta 信息，告诉 <code>go get</code> 去 github 找。</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/IMG_6889.PNG><img class=mx-auto alt="与 go get 交互" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/IMG_6889.PNG></a></p><p>当 go get 收到上图的 HTTP 响应，会根据第一个红框的提示去 <a href=https://github.com/golang-design/verbose>https://github.com/golang-design/verbose</a> 这里找对应的包；而如果是浏览器过来的请求，则会重定向到 pkg.go.dev 查看包的详细信息。前者实际就是和 go get 交互的协议，具体的可以在<a href=https://golang.org/cmd/go/#hdr-Remote_import_paths>这里</a>看到。</p><p>有了短网址跳转，自然就想知道访问每个短网址的 uv/pv 情况，如果访问路径 <code>/s</code> 后不接任何字符，那就返回短网址的汇总信息：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114195514.png><img class=mx-auto alt=uv/pv src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114195514.png></a></p><p>了解清楚了功能，我们来看看如何用代码实现。</p><p><code>main</code> 函数会首先会根据传入的命令行参数 *daemon 来决定是开启一个 server，还是执行增加 alias（短链接和长链接对）、更新 alias 的命令。前者持续运行，后者则只执行一次，程序就会结束。</p><p>如果是启动一个 server，会首先连接 redis，初始化一个本地的 cache，用于加快响应速度；同时会启动两个异步协程：counting 和 backup，前者用于计数 uv/pv，后者则用于备份 redis 中的数据。</p><p>接着会注册 <code>/.info</code>、<code>/s</code>、<code>/x</code> 三个 handler，<code>/.info</code> 用来看一下程序相关的版本信息（内部会通过 nginx 屏蔽，外部无法访问）；<code>/s</code> 用来处理短链接；<code>/x</code> 则用于执行包相关的请求。</p><p><code>/s</code> 的处理逻辑是先从本地 cache 拿和短链相对应的实际链接，如果没有拿到，则从 redis 拿，最后调用 <code>http.Redirect(w, r, url, http.StatusTemporaryRedirect)</code> 重定向到实际链接地址。</p><p>最后，启动一个异步协程把访问信息（ip）添加到一个 channel 中去，用于计算 pv/uv。</p><p>关于 <code>/s</code> handler 还有一类特殊的请求，即短链接为空，直接访问 <code>https://golang.design/s/</code>，那就会返回所有的短链接并且展示相应的 uv/pv 信息。</p><p>完成上述这些，最后开始监听端口，处理请求。</p><p>另外一个流程就是根据命令行参数执行 alias 的增删改查，是一次性的行为。</p><p>整体的架构图：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114234707.png><img class=mx-auto alt=架构图 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114234707.png></a></p><p>最后我们来看下如何部署到自己的云主机上，我会修改成自己的域名：qcrao.com。当然，redir 还会向 Google Analytics 发送追踪数据，需要将 id 改成自己的。</p><p>首先要安装 docker 和 docker-compose，这个就不细说，对着命令敲就好了。</p><p>然后编译 redir.app：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make all
</span></span></code></pre></div><p>启动 redir 和 redis 容器：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make up
</span></span></code></pre></div><p>添加一个新的 alias：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./redir.app -a ck-s -l https://changkun.de/s/
</span></span></code></pre></div><p>访问 <a href=https://www.qcrao.com/s/>https://www.qcrao.com/s/</a>，大功告成：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114232317.png><img class=mx-auto alt=qcrao.com/s/ src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114232317.png></a></p><p>总体来看，项目的逻辑是比较简单清晰的，但涉及到东西其实也不少，麻雀虽小，五脏俱全。从实现到部署到运维，都需要了解。如果把整个都走通了，还是很有收获的。</p><p>在“玩弄” redir 的过程中，修了一下 Makefile 文件，增加了一个 stats 页面的排序，也因此成为 redir 的从 Contributor，nice！</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/become-contributor-of-redir/>https://qcrao.com/post/become-contributor-of-redir/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/how-to-write-a-things3-client/ title="如何写一个 things3 client">如何写一个 things3 client</a></li><li><a href=https://qcrao.com/post/some-convenient-settings-of-mac/ title="几个小设置让 mac 更好用">几个小设置让 mac 更好用</a></li><li><a href=https://qcrao.com/post/100-go-mistakes-reading-notes/ title="深度阅读之《100 Go Mistakes and How to Avoid Them》">深度阅读之《100 Go Mistakes and How to Avoid Them》</a></li><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>