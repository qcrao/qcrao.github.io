<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>『���』引发的线上事故 | qcrao 的博客</title><meta property="og:title" content="『���』引发的线上事故 - qcrao 的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-04-27T00:10:53+08:00"><meta property="article:modified_time" content="2020-04-27T00:10:53+08:00"><meta name=Keywords content="golang,go语言,后端,个人成长"><meta name=description content="『���』引发的线上事故"><meta name=author content="饶全成"><meta property="og:url" content="https://qcrao.com/post/codec-accident/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://qcrao.com>qcrao 的博客</a><p class=description>专注于 Go 语言(golang)、后端架构、个人成长</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://qcrao.com>首页</a>
<a href=https://qcrao.com/archives/ title=归档>归档</a>
<a href=https://qcrao.com/about/ title=关于>关于</a>
<a href=https://qcrao.com/readings/ title=阅读>阅读</a>
<a href=https://qcrao.com/ishare/ title=分享>分享</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>『���』引发的线上事故</h1></header><date class="post-meta meta-date">2020年4月27日</date><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>最近遇到了一起依赖升级 + 异常数据引发的线上事故，教训惨痛，本文对此进行回故和总结。</p><h1 id=背景>背景</h1><p>起因是我们使用的服务框架版本比较老，GC 次数的 metrics 打点一直为 0，咨询了相关同学后，决定升级框架。升级的过程中，出现了 <code>use of internal package xxx not allowed</code> 的报错，又咨询了一下相关同学后，尝试使用 <code>go mod</code> 解决。</p><p>从 <code>go vendor</code> 到 <code>go mod</code> 的升级的过程也不太顺利，这里按下不表，最终是升级成功了。一同升级的还有 Go 版本，从 1.11 升级到 1.13。</p><p>周四上完线后，一切都看似很不错：内存占用、GC 消耗的 CPU 有了优化，GC 次数的监控也有了。因为涉及到公司内部数据，图我就不放了。</p><p>周五、周六都平安度过，周日出问题了，小组的同学从下午 12 点左右一直肝到凌晨 12 点，才松了一口气。可怜我们来之不易的一个周日！</p><h1 id=现象>现象</h1><p>周日 11 点 45 左右，端口的调用失败率报警，同时有业务方反馈调用接口报错。</p><p>同志们，关键时刻，完善的报警能给事故的处理和恢复赢得时间啊！</p><p>By case 排查，发现服务 shard3 集群的机器报 <code>i/o timeout</code> 错误。服务共有 4 个分片集群（根据 ID hash 到对应分片），其他 3 个集群完全正常。接着发现 shard3 集群的机器内存正常、端口还在，但 <code>in/out</code> 流量全部掉到几十 KB/s，看日志也没有发现任何异常。</p><p>重启 shard3 集群的服务，重启后的服务恢复正常，访问 debug 端口，也是正常的。然而，十几分钟后，恢复的服务再次出现异常：<code>in/out</code> 流量再次掉到几十 KB/s，访问 debug 端口也没有任何响应，开始慌了。</p><h1 id=处理>处理</h1><blockquote><p>上线出问题，第一时间回滚！</p></blockquote><p>稳定性里面很重要的一条就是：有问题，先回滚。先止损，将事故影响降到最低，事后再来追查根因，总结复盘。</p><p>于是开始操作回滚，<code>reset</code> 到周四上线之前的一个 commit，重新打包，上线 shard3 集群。之后，对外接口完全恢复，操作回滚其他集群。</p><p>服务启动之前，需要先加载几十个 G 左右的数据，启动过程长达 10+ min。我申请了一台线上问题机器的 root 权限，执行了 <code>strace -p</code> 命令：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424084816.png><img class=mx-auto alt="strace -p" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424084816.png></a></p><p>发现服务卡在 futex 系统调用上，这很明显是一个 timer，但是 timer 为何会卡住？正常情况下，会有各种像 write，read 的系统调用，至少打日志、上报 mertrics 打点数据都会有 write 系统调用吧，哈？再执行 <code>perf top</code> 命令：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200426134421.png><img class=mx-auto alt="perf top" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200426134421.png></a></p><p>相关的只有 <code>codec</code> 函数，再看服务进程：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200426134739.png><img class=mx-auto alt="perf top -r 80 -g -p" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200426134739.png></a></p><p>看 perf 输出的结果，全部聚焦到 codec 这个第三方库上，主要的两个函数竟然是 <code>codec.quoteStr</code> 和 <code>utf8.DecodeRuneInString</code>。而我们用 codec 的地方是在程序启动时加载数据文件以及定时的 dump 文件到本地。现在程序已经启动了，只可能是 dump 文件出问题了。查看相关日志，果然有开始 dump 文件的日志记录，却一直没有 dump 成功的记录。</p><h1 id=追查>追查</h1><p>事后追查阶段尝试在 <code>test</code> 集群上重现故障，因为只有单个分片出问题，说明此故障和特定数据有关，是 hash 到分片 3 的数据引起的问题。</p><p>又因为 <code>test</code> 集群并没有分片，所以强行（改代码 && 改环境变量）将其伪装成 shard3 集群，然则并没有复现，猜测可能是计划下线了。</p><p>周二的时候，终于在 test 集群上模拟分片 1 时重现了线上故障。</p><p>对比 codec 的版本问题，果然有问题：周四上线前，<code>vendor.json</code> 里的版本是 v1.1.7，上线后，升级到了 v1.1.8，看来找到问题了！修改 codec 的版本，重新编译、部署，问题依然存在！</p><p>这时，组里其他同学反馈 2018 年的时候也出过 codec 的问题，当时也是出现了异常数据导致重启时加载文件不成功。于是我直接将周四上线前 vendor 文件夹里 <code>codec.quoteStr</code> 函数的代码和 codec 的 v1.1.7 代码进行对比，并不相同！<code>vendor.json</code> 里的版本并没有正确反应 vendor 里实际的 codec 版本！！！</p><p>进一步查看提交记录，发现在 2017 年 11 月份的时候有一次提交，修改了 vendor 文件夹里的代码，但这时 <code>vendor.json</code> 并没有 codec 记录。而在 2019 年 11 月的一次提交，则只在 <code>vendor.json</code> 里增加了一条 codec 记录，vendor 文件夹里的代码并没有更改：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;checksumSHA1&#34;</span>: <span style=color:#d14>&#34;wfboMqCTVImg0gW31jvyvCymJPE=&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;path&#34;</span>: <span style=color:#d14>&#34;github.com/ugorji/go/codec&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;revision&#34;</span>: <span style=color:#d14>&#34;e118e2d506a6b252f6b85f2e2f2ac1bfed82f1b8&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;revisionTime&#34;</span>: <span style=color:#d14>&#34;2019-07-23T09:17:30Z&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#d14>&#34;tree&#34;</span>: <span style=color:#0086b3>true</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>仔细比对代码，主要差异在这：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200425173458.png><img class=mx-auto alt="codec 版本对比" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200425173458.png></a></p><p>从现象及源码看，大概率是在 <code>codec.quoteStr</code> 里死循环了！由于 Go 1.14 前都无法抢占正在执行无限循环且没有任何函数调用的 goroutine，因此一旦出现死循环，将要进行 GC 的时候，其他所有 goroutine 都会停止，并且都在等着无限循环的 goroutine 停下来，遗憾的是，由于 <code>for {}</code> 循环里没有进行函数调用，无法插入抢占标记并进行抢占。于是，就出现了这样一幕：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/swwwkwqwy.jpeg><img class=mx-auto alt=围观 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/swwwkwqwy.jpeg></a></p><p>只有 dump 数据文件这一个 goroutine 在干活，而且做的又是无限循环，服务整体对外表现就像是“死机”了一样。并且这个 goroutine 由一个 timer 触发工作，所以一开始我们看到的卡在一个 futex 调用上就可以解释得通。因为 runtime 都停止工作了，timer 自然就没法“到期”了。</p><p>接着，使用 Go 1.14 去编译有问题的代码版本，上到 test 集群，果然问题“消失”。服务状态完全恢复正常，唯一不正常的是数据文件无法 dump 下来了，因为即使是 Go 1.14，也依然在执行无限循环，不干“正事”。</p><p>接下来的问题就是找到异常的数据了。使用上线前的版本（使用 go vendor），将 codec 替换为最新的 v1.1.8 版本，并且在 <code>quoteStr</code> 函数里打上了几行日志：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424110256.png><img class=mx-auto alt="加上 debug 日志" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424110256.png></a></p><p>部署到 test 集群，问题复现：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424110546.png><img class=mx-auto alt=问题日志 src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424110546.png></a></p><p>异常数据就是：“孙���雷”：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424111127.png><img class=mx-auto alt="中文转 Unicode" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200424111127.png></a></p><p>为什么会引发死循环，在调用 <code>utf8.DecodeRuneInString</code> 函数后：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>c <span style=color:#000;font-weight:700>==</span> utf8.RuneError
</span></span><span style=display:flex><span>size <span style=color:#000;font-weight:700>==</span> <span style=color:#099>3</span>
</span></span></code></pre></div><p>再看 <code>RuneError</code> 的定义：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#000;font-weight:700>const</span> RuneError = <span style=color:#d14>&#39;\uFFFD&#39;</span>
</span></span></code></pre></div><p>看一下两个版本的代码不同之处：</p><p><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200425173458.png><img class=mx-auto alt="codec 版本对比" src=https://cdn.jsdelivr.net/gh/qcrao/images/blog/20200425173458.png></a></p><p>老版本的代码，不会进入 if 分支，而新版本的代码，由于 <code>c == utf8.RuneError</code>，所以先进入 if 分支，之后，<code>size == 3</code>，不满足里层分支，直接 continue 了，因此 <code>i</code> 值并没有发生变化，死循环就这么发生了。</p><p>最后就是找到异常数据到底属于哪个计划。我尝试去每个集群的机器上，从数据文件里寻找“孙���雷”。但文件太大了，几十个 G，<code>grep</code> 搞不定，没关系，使用 dd 工具：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dd <span style=color:#000;font-weight:700>if</span><span style=color:#000;font-weight:700>=</span>model_20200423155728 <span style=color:teal>bs</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1024</span> <span style=color:teal>skip</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>3600000</span> <span style=color:teal>count</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1200</span> | grep <span style=color:#d14>&#39;孙���雷&#39;</span>
</span></span></code></pre></div><p>使用二分法找到了“孙���雷”！关于 <code>dd + grep</code> 的用法，总结了几点：</p><ol><li>每次从文件开头先跳过 <code>skip*bs</code> 大小的内容，复制 <code>count*bs</code> 大小的内容过来用 grep 查询。</li><li>如果不设置 count，就会查找整个文件，如果查到，则会有输出；否则无。</li><li>对于特别大的文件，可以先把 count 设为跳过一半文件大小的值，采用二分法查找。如果找到，则限定在了前半范围，否则在后半部分。使用类似的方法继续查找……</li><li>如果找到，最后会输出 count*bs 大小的内容。</li></ol><h1 id=反思>反思</h1><ol><li>服务重大版本更新，至少在线下跑一周。</li><li>有问题，第一时间回滚。</li><li>对于工具的使用要规范。如不要随意更改 vendor 文件夹的内容而不同步更新 <code>vendor.json</code> 文件，反之亦然。</li><li>因为 <code>go mod</code> 的版本选择以及不遵守开源规范的第三方库作者会让使用者不知不觉、被动地引入一些难以发现的问题。可以使用 <code>go mod vendor</code> 代替，如果要锁死版本的话，使用 replace。</li></ol><h1 id=相关阅读>相关阅读</h1><p>【stw 如何停止 goroutine】 <a href=https://medium.com/a-journey-with-go/go-how-does-go-stop-the-world-1ffab8bc8846>https://medium.com/a-journey-with-go/go-how-does-go-stop-the-world-1ffab8bc8846</a></p><p>【Go Modules 终极入门】 <a href=https://eddycjy.com/posts/go/go-moduels/2020-02-28-go-modules/>https://eddycjy.com/posts/go/go-moduels/2020-02-28-go-modules/</a></p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://qcrao.com>饶全成</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://qcrao.com/post/codec-accident/>https://qcrao.com/post/codec-accident/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=qcrao/blog_comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2022 <a href=https://qcrao.com>qcrao 的博客 By 饶全成</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>鄂ICP备20006251号-1</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144930666-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "15ed44493a8a4df682815ddf8c84ff23"}'></script></div><div id=secondary><section class=widget><form id=search action=https://qcrao.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://qcrao.com>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://qcrao.com/post/100-go-mistakes-reading-notes/ title="深度阅读之《100 Go Mistakes and How to Avoid Them》">深度阅读之《100 Go Mistakes and How to Avoid Them》</a></li><li><a href=https://qcrao.com/post/memory-leak-of-go-map/ title="Go map 竟然也会发生内存泄漏？">Go map 竟然也会发生内存泄漏？</a></li><li><a href=https://qcrao.com/post/what-is-upstream-downstream/ title="你说的下游是 upstream 吧？">你说的下游是 upstream 吧？</a></li><li><a href=https://qcrao.com/post/migrate-blog-to-cloudflare-pages/ title="将博客迁移到了 Cloudflare Pages">将博客迁移到了 Cloudflare Pages</a></li><li><a href=https://qcrao.com/post/blogs-written-by-xargin/ title=那些年曹大写的文章>那些年曹大写的文章</a></li><li><a href=https://qcrao.com/post/content-is-more-important/ title=最重要的是内容>最重要的是内容</a></li><li><a href=https://qcrao.com/post/look-up-go-doc-gracefully/ title="写 Go 时如何优雅地查文档">写 Go 时如何优雅地查文档</a></li><li><a href=https://qcrao.com/post/talk-about-map-extra-field/ title="曹大带我学 Go（11）—— 从 map 的 extra 字段谈起">曹大带我学 Go（11）—— 从 map 的 extra 字段谈起</a></li><li><a href=https://qcrao.com/post/go-tls-pr-by-xargin/ title="曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr">曹大带我学 Go（10）—— 如何给 Go 提性能优化的 pr</a></li><li><a href=https://qcrao.com/post/start-to-build-up-personal-tools/ title="曹大带我学 Go（9）—— 开始积累自己的工具库">曹大带我学 Go（9）—— 开始积累自己的工具库</a></li></ul></section><section class=widget><h3 class=widget-title>我写的书</h3><ul class=widget-list><li><a href=https://golang.design/go-questions/ title="《Go 程序员面试笔试宝典》" target=_blank style=color:red><img src=/book.png></a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.xargin.com/ title=曹大的博客>曹大的博客</a></li><li><a target=_blank href=https://eddycjy.com/ title=煎鱼的博客>煎鱼的博客</a></li><li><a target=_blank href=http://lessisbetter.site/ title=大彬的博客>大彬的博客</a></li><li><a target=_blank href=https://wujunze.com/ title="Panda 的博客">Panda 的博客</a></li><li><a target=_blank href=https://mytechshares.com/ title=董泽润>董泽润</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://qcrao.com/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>