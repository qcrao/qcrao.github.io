<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="日拱一卒，终有所成！"><title>喜提 redir contributor | qcrao</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-144930666-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '6d54b847f6c5fb175b1ed2d153159403';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">喜提 redir contributor</h1><a id="logo" href="/.">qcrao</a><p class="description">码农桃花源</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/readings/"><i class="fa fa-book"> 阅读</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">喜提 redir contributor</h1><div class="post-meta">Nov 16, 2020<span> | </span><span class="category"><a href="/categories/编程语言/">编程语言</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div></div></div><div class="post-content"><p>看多了 Go 源代码，看一看应用，尤其是比较短小且有趣的应用代码，感觉很有意思，而且举重若轻。</p>
<p>如果顺带修一下小的<a href="https://github.com/golang-design/redir/pull/3" target="_blank" rel="noopener">错误</a>，成为 Contributor，那就更多了一种成就感。就像杨文前几天成为 Go Contributor <a href="https://go-review.googlesource.com/c/tools/+/269397" target="_blank" rel="noopener">那样</a>，从小处开始，慢慢提升技术含量，总有一天，慢慢成为真正的 Contributor，像曹大<a href="https://go-review.googlesource.com/c/go/+/263277" target="_blank" rel="noopener">那样</a>。</p>
<p>某天欧神和杨文不知道怎么鼓捣出了一个 <a href="https://golang.design/" target="_blank" rel="noopener">golang.design</a> 网站，前一阵子欧神又发布了一个 <a href="https://github.com/golang-design/redir" target="_blank" rel="noopener">redir</a> 项目。它其实是一个跳转，比如，欧神分享的 Gophercon 2020 的 PPT 链接：<a href="https://golang.design/s/gophercon2020，其实最后会跳转到一个" target="_blank" rel="noopener">https://golang.design/s/gophercon2020，其实最后会跳转到一个</a> dropbox 的一个文件分享页面。但是用 “/s/gophercon2020” 就会显得非常的优雅和高级。类似的，还有一些欧神做的分享，如 <a href="https://golang.design/s/go2generics" target="_blank" rel="noopener">https://golang.design/s/go2generics</a> 等，都会通过 <code>/s/</code> 跳转到实际的地址去。至于为什么是 <code>/s/</code> 路径，其实这个项目最初的名字是 short，也就是短网址的意思。</p>
<p>所以，我今天要介绍的就是 redir 的实现原理以及部署。</p>
<p>首先来看一下 redir 的两个核心功能：短网址跳转（/s）；处理 <code>go get</code> 请求（/x）。前者很好理解，我访问短网址 <a href="https://golang.design/s/go2generics，redir" target="_blank" rel="noopener">https://golang.design/s/go2generics，redir</a> 给我重定向到真实的 google slice 的地址；后者则不那么好理解，它处理的是我们在项目中 import 了一个 golang.design 下面的某个包，例如：<code>import &quot;golang.design/x/verbose&quot;</code><br>，那么 <code>go get</code> 来获取这个包的时候会去 github 上 golang.design 相应目录下找，但这一切并不是自然发生的，需要通过返回的 <code>header</code> 告知 <code>go get</code> 一些信息。</p>
<p>对于比较知名的，如 github，我这样写：<code>import github.com/go-redis/redis/v8</code>，<code>go get</code> 就知道去 github 官网去找，但是对于 golang.design 的库那就不知道怎么找了，所以它会尝试访问 <code>https://golang.design/x/pkg/foo?go-get=1</code> 来获取相关信息，于是 <code>/x</code> handler 就在 header 里返回 meta 信息，告诉 <code>go get</code> 去 github 找。</p>
<p><img src="https://cdn.jsdelivr.net/gh/qcrao/images/blog/IMG_6889.PNG" alt="与 go get 交互"></p>
<p>当 go get 收到上图的 HTTP 响应，会根据第一个红框的提示去 <a href="https://github.com/golang-design/verbose" target="_blank" rel="noopener">https://github.com/golang-design/verbose</a> 这里找对应的包；而如果是浏览器过来的请求，则会重定向到 pkg.go.dev 查看包的详细信息。前者实际就是和 go get 交互的协议，具体的可以在<a href="https://golang.org/cmd/go/#hdr-Remote_import_paths" target="_blank" rel="noopener">这里</a>看到。</p>
<p>有了短网址跳转，自然就想知道访问每个短网址的 uv/pv 情况，如果访问路径 <code>/s</code> 后不接任何字符，那就返回短网址的汇总信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114195514.png" alt="uv/pv"></p>
<p>了解清楚了功能，我们来看看如何用代码实现。</p>
<p><code>main</code> 函数会首先会根据传入的命令行参数 *daemon 来决定是开启一个 server，还是执行增加 alias（短链接和长链接对）、更新 alias 的命令。前者持续运行，后者则只执行一次，程序就会结束。</p>
<p>如果是启动一个 server，会首先连接 redis，初始化一个本地的 cache，用于加快响应速度；同时会启动两个异步协程：counting 和 backup，前者用于计数 uv/pv，后者则用于备份 redis 中的数据。</p>
<p>接着会注册 <code>/.info</code>、<code>/s</code>、<code>/x</code> 三个 handler，<code>/.info</code> 用来看一下程序相关的版本信息（内部会通过 nginx 屏蔽，外部无法访问）；<code>/s</code> 用来处理短链接；<code>/x</code> 则用于执行包相关的请求。</p>
<p><code>/s</code> 的处理逻辑是先从本地 cache 拿和短链相对应的实际链接，如果没有拿到，则从 redis 拿，最后调用 <code>http.Redirect(w, r, url, http.StatusTemporaryRedirect)</code> 重定向到实际链接地址。</p>
<p>最后，启动一个异步协程把访问信息（ip）添加到一个 channel 中去，用于计算 pv/uv。</p>
<p>关于 <code>/s</code> handler 还有一类特殊的请求，即短链接为空，直接访问 <code>https://golang.design/s/</code>，那就会返回所有的短链接并且展示相应的 uv/pv 信息。</p>
<p>完成上述这些，最后开始监听端口，处理请求。</p>
<p>另外一个流程就是根据命令行参数执行 alias 的增删改查，是一次性的行为。</p>
<p>整体的架构图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114234707.png" alt="架构图"></p>
<p>最后我们来看下如何部署到自己的云主机上，我会修改成自己的域名：qcrao.com。当然，redir 还会向 Google Analytics 发送追踪数据，需要将 id 改成自己的。</p>
<p>首先要安装 docker 和 docker-compose，这个就不细说，对着命令敲就好了。</p>
<p>然后编译 redir.app：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make all</span><br></pre></td></tr></table></figure>

<p>启动 redir 和 redis 容器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make up</span><br></pre></td></tr></table></figure>

<p>添加一个新的 alias：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redir.app -a ck<span class="_">-s</span> -l https://changkun.de/s/</span><br></pre></td></tr></table></figure>

<p>访问 <a href="https://www.qcrao.com/s/，大功告成：" target="_blank" rel="noopener">https://www.qcrao.com/s/，大功告成：</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/qcrao/images/blog/20201114232317.png" alt="qcrao.com/s/"></p>
<p>总体来看，项目的逻辑是比较简单清晰的，但涉及到东西其实也不少，麻雀虽小，五脏俱全。从实现到部署到运维，都需要了解。如果把整个都走通了，还是很有收获的。</p>
<p>在“玩弄” redir 的过程中，修了一下 Makefile 文件，增加了一个 stats 页面的排序，也因此成为 redir 的从 Contributor，nice！</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>饶全成</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/11/16/become-contributor-of-redir/">https://qcrao.com/2020/11/16/become-contributor-of-redir/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文章著作权归作者所有，任何形式的转载都请注明出处。</li></ul></div><br><div class="tags"><a href="/tags/golang/">golang</a></div><div class="post-nav"><a class="next" href="/2020/09/05/concurrency-in-go-reading-notes/">深度阅读之《Concurrency in Go》</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '7e91ec94cfb5913e3d6b',
  clientSecret: '902f91e26bc75c9f8d912557492476d0be254667',
  repo: 'qcrao.github.io',
  owner: 'qcrao',
  admin: ['qcrao'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://qcrao.com"></form></div><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"><input type="hidden" name="si" value="https://qcrao.com"><input name="tn" type="hidden" value="bds"><input name="cl" type="hidden" value="3"><input name="ct" type="hidden" value="2097152"><input name="s" type="hidden" value="on"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/求职/">求职</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/">编程语言</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/故障排查/" style="font-size: 15px;">故障排查</a> <a href="/tags/协议/" style="font-size: 15px;">协议</a> <a href="/tags/内存重排/" style="font-size: 15px;">内存重排</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/简历/" style="font-size: 15px;">简历</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/编译原理/" style="font-size: 15px;">编译原理</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/11/16/become-contributor-of-redir/">喜提 redir contributor</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/05/concurrency-in-go-reading-notes/">深度阅读之《Concurrency in Go》</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/07/linux-performance-reading-notes/">《Linux 性能优化》读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/10/head-first-design-pattern-reading-notes/">《Head First 设计模式》读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/06/dive-into-go-sync-map/">深度解密Go语言之sync.map</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/27/codec-accident/">“���”引发的线上事故</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/20/dive-into-go-sync-pool/">深度解密Go语言之sync.pool</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/03/talk-about-g0/">聊聊 g0</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/23/how-to-traverse-defer-links/">defer 链表如何被遍历执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/08/high-performance-mysql-reading-notes/">《高性能 MySQL》读书笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/qcrao/Go-Questions" title="Go-Questions" target="_blank">Go-Questions</a><ul></ul><a href="http://xargin.com/" title="No HeadBack" target="_blank">No HeadBack</a><ul></ul><a href="https://draveness.me/" title="面向信仰编程" target="_blank">面向信仰编程</a><ul></ul><a href="https://eddycjy.gitbook.io/golang/" title="跟煎鱼学 Go" target="_blank">跟煎鱼学 Go</a><ul></ul><a href="http://lessisbetter.site/" title="大彬 - Less is better" target="_blank">大彬 - Less is better</a><ul></ul><a href="https://wujunze.com/" title="Panda - Just for fun" target="_blank">Panda - Just for fun</a><ul></ul><a href="https://blog.changkun.de/" title="欧神" target="_blank">欧神</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async="async"></script><span> | </span><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span> | </span><i class="fa fa-keyboard-o"></i><span class="post-count">181.6k</span><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">qcrao.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 鄂ICP备20006251号-1</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>